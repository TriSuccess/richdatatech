<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paid Course – RichDataTech</title>
  <link href="https://vjs.zencdn.net/8.23.4/video-js.css" rel="stylesheet" />
  <style>
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      background: #f3f4f6;
      display: flex;
      flex-direction: column;
      font-family: 'Proxima Nova', sans-serif;
      margin: 0;
    }
    header {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1.25rem 1rem;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    nav.main-nav {
      display: flex;
      gap: 1.25rem;
      font-size: 1rem;
      position: absolute;
      left: 50%;
      top: 5%;
      transform: translateX(-50%);
      margin-top: 34px;
    }
    nav a {
      text-decoration: none;
      color: #23272a;
      transition: color 0.2s, font-weight 0.2s;
    }
    nav a:hover {
      color: #0573ff;
      font-weight: bold;
    }
    .auth-box {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    .btn, .btn-google, .btn-github, .btn-gradient {
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      outline: none;
      cursor: pointer;
      border-radius: 0.25rem;
      transition: background 0.2s;
      margin-bottom: 0.3rem;
      padding: 0.25rem 0.75rem;
    }
    .btn-blue {
      background: #2563eb;
      color: #fff;
    }
    .btn-blue:hover {
      background: #1d4ed8;
    }
    .btn-google {
      background: #ef4444;
      color: #fff;
      width: 100%;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
    }
    .btn-google:hover {
      background: #dc2626;
    }
    .btn-github {
      background: #1f2937;
      color: #fff;
      width: 100%;
      padding: 0.5rem 0;
    }
    .btn-github:hover {
      background: #000;
    }
    .btn-gradient {
      background: linear-gradient(to right, #4ade80, #3b82f6);
      color: #fff;
      padding: 0.5rem 1.5rem;
      border-radius: 0.375rem;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      border: none;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 0;
    }
    .btn-gradient:hover {
      background: linear-gradient(to right, #22d3ee, #1d4ed8);
    }
    #logged-in-span {
      margin-right: 10px;
      font-size: 0.7rem;
      font-weight: normal;
      color: #065f46;
      opacity: 1;
      margin-top: 0.1rem;
    }
    #status-span {
      margin-right: 10px;
      font-size: 0.8rem;
      color: #0573ff;
      opacity: 1;
      margin-top: 0.1rem;
    }
    .hidden { display: none !important; }
    .main-content {
      flex-grow: 1;
      padding-top: 1rem;
      padding-left: 1rem;
      padding-right: 1rem;
      background: linear-gradient(to right, #d1d5db 0%, #d1d5db 50%, #e5e7eb 100%);
    }
    .course-content {
      margin-top: 2rem;
    }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center;}
    .justify-center { justify-content: center;}
    .justify-between { justify-content: space-between;}
    .max-w-5xl { max-width: 64rem; }
    .max-w-3xl { max-width: 48rem; }
    .w-full { width: 100%; }
    .mx-auto { margin-left: auto; margin-right: auto;}
    .mb-8 { margin-bottom: 2rem;}
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-4 { margin-bottom: 1rem;}
    .mb-2 { margin-bottom: 0.5rem;}
    .mt-2 { margin-top: 0.5rem;}
    .mt-4 { margin-top: 1rem;}
    .rounded { border-radius: 0.25rem;}
    .rounded-md { border-radius: 0.375rem;}
    .rounded-lg { border-radius: 0.5rem;}
    .shadow { box-shadow: 0 1px 2px rgba(0,0,0,0.08);}
    .shadow-md { box-shadow: 0 4px 6px rgba(0,0,0,0.11);}
    .shadow-lg { box-shadow: 0 10px 15px rgba(0,0,0,0.15);}
    .block { display: block;}
    .text-center { text-align: center;}
    .text-xs { font-size: 0.75rem;}
    .text-sm { font-size: 0.875rem;}
    .text-base { font-size: 1rem;}
    .text-lg { font-size: 1.125rem;}
    .text-xl { font-size: 1.25rem;}
    .text-4xl { font-size: 2.25rem;}
    .font-semibold { font-weight: 600;}
    .font-bold { font-weight: 700;}
    .font-medium { font-weight: 500;}
    .leading-relaxed { line-height: 1.625;}
    .text-white { color: #fff;}
    .text-black { color: #000;}
    .text-blue-600 { color: #2563eb;}
    .text-blue-700 { color: #1d4ed8;}
    .text-green-700 { color: #065f46;}
    .text-gray-500 { color: #6b7280;}
    .text-gray-600 { color: #4b5563;}
    .text-gray-700 { color: #374151;}
    .text-gray-800 { color: #1f2937;}
    .bg-white { background: #fff;}
    .bg-black { background: #000;}
    .bg-blue-600 { background: #2563eb;}
    .bg-blue-700 { background: #1d4ed8;}
    .bg-red-500 { background: #ef4444;}
    .bg-red-600 { background: #dc2626;}
    .bg-gray-800 { background: #1f2937;}
    .bg-gray-200 { background: #e5e7eb;}
    .bg-gray-300 { background: #d1d5db;}
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem;}
    .px-4 { padding-left: 1rem; padding-right: 1rem;}
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem;}
    .border { border: 1px solid #d1d5db;}
    .border-gray-500 { border: 1px solid #6b7280;}
    .border-blue-400 { border: 1px solid #60a5fa;}
    .grid { display: grid;}
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr));}
    .gap-8 { gap: 2rem;}
    .shadow-sm { box-shadow: 0 1px 2px rgba(0,0,0,0.05);}
    .list-disc { list-style-type: disc;}
    .pl-5 { padding-left: 1.25rem;}
    .space-y-2 > * + * { margin-top: 0.5rem;}
    .transition-all { transition: all 0.15s;}
    .duration-150 { transition-duration: 150ms;}
    .transition { transition: all 0.2s;}
    .relative { position: relative;}
    .absolute { position: absolute;}
    .top-2 { top: 0.5rem;}
    .right-2 { right: 0.5rem;}
    .w-80 { width: 20rem; }
    .z-50 { z-index: 50;}
    .fixed { position: fixed;}
    .inset-0 { top: 0; left: 0; right: 0; bottom: 0; }
    .bg-opacity-50 { background: rgba(0,0,0,0.5);}
    .border-t { border-top: 1px solid #d1d5db;}
    .block { display: block; }
    .mt-8 { margin-top: 2rem; }
    /* Responsiveness */
    @media (max-width: 639px) {
      nav.main-nav {
        position: static;
        flex-direction: row;
        justify-content: space-around;
        width: 100%;
        margin-top: 0.25rem;
        gap: 2px;
        font-size: 0.9rem;
        transform: none;
      }
      header { padding-bottom: 0.15rem; }
    }
    @media (max-width: 700px) {
      .footer-table {
        grid-template-columns: 1fr !important;
        gap: 24px !important;
        text-align: center !important;
      }
      .footer-table > div {
        margin-bottom: 18px;
      }
    }
    .footer-table a:hover svg path { fill: #999 !important; }
    #auth-modal { animation: fadeIn 0.25s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    /* Custom for video and progress bar */
    .video-js { width: 100%; border-radius: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.11);}
    .progress-bar-bg { background: #e5e7eb; border-radius: 9999px; height: 0.75rem;}
    .progress-bar-fill { background: #2563eb; height: 0.75rem; border-radius: 9999px;}
    /* Hide scrollbars */
    ::-webkit-scrollbar { width: 8px; background: #e5e7eb; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
  <script src="https://vjs.zencdn.net/8.23.4/video.min.js"></script>
</head>
<body>
<!-- HEADER -->
<header>
  <div class="header-top">
    <div>
      <a href="index.html">
        <img src="https://www.richdatatech.com/images/richdatatech.png" alt="RichDataTech Logo" style="height:4rem; width:auto; object-fit:contain;" />
      </a>
    </div>
    <div id="auth-box" class="auth-box">
      <button id="open-auth-btn" class="btn btn-blue">Login / Register</button>
      <span id="logged-in-span" class="hidden">Logged In</span>
      <span id="status-span" class="hidden"></span>
    </div>
  </div>
  <nav class="main-nav">
    <a href="powerbi.html">Power BI</a>
    <a href="courses.html">All Courses</a>
    <a href="aipowertips.html">AI Power Tips</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<!-- MAIN -->
<main class="main-content">
  <div id="course-content" class="course-content"></div>
  <br><br>
</main>

<!-- FOOTER -->
<footer style="background:#23272a; color:#fff; padding:38px 0 18px 0;">
  <div style="max-width:950px; margin:0 auto;">
    <div style="
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 32px;
      align-items: flex-start;
      justify-items: center;
      text-align: center;
    " class="footer-table">
      <div>
        <div style="font-weight:600; font-size:1.09rem; margin-bottom:5px;">RichDataTech</div>
        <div style="font-size:0.97rem; color:#d1d5db;">Advance your future with premium courses, AI tools, and valuable resources.</div>
      </div>
      <div>
        <div style="font-weight:600; font-size:1.09rem; margin-bottom:7px;">Quick Links</div>
        <ul style="list-style:none; padding:0; margin:0; font-size:0.97rem;">
          <li style="margin-bottom:4px;"><a href="powerbi.html" style="color:#fff; text-decoration:none;">Power BI</a></li>
          <li style="margin-bottom:4px;"><a href="aitools.html" style="color:#fff; text-decoration:none;">AI Tools</a></li>
          <li style="margin-bottom:4px;"><a href="courses.html" style="color:#fff; text-decoration:none;">All Courses</a></li>
        </ul>
      </div>
      <div>
        <div style="font-weight:600; font-size:1.09rem; margin-bottom:7px;">Follow Us</div>
        <div style="margin-bottom:10px;">
          <a href="https://www.youtube.com/@richdatatech" target="_blank" title="YouTube" style="margin:0 7px; display:inline-block;">
           <svg width="26" height="26" viewBox="0 0 576 512"><path fill="#555" d="M549.655 124.083c-6.281-23.725-24.96-42.28-48.655-48.648C465.69 64 288 64 288 64s-177.69 0-213 11.435c-23.695 6.368-42.374 24.923-48.655 48.648C16 159.405 16 256 16 256s0 96.595 10.345 131.917c6.281 23.725 24.96 42.28 48.655 48.648C110.31 448 288 448 288 448s177.69 0 213-11.435c23.695-6.368 42.374-24.923 48.655-48.648C560 352.595 560 256 560 256s0-96.595-10.345-131.917zM232 336V176l142.857 80L232 336z"/></svg>
         </a>
          <a href="https://www.instagram.com/richdatatech?igsh=MWl0eHdoZGdoeWVxeA==" target="_blank" title="Instagram" style="margin:0 7px; display:inline-block;">
            <svg width="26" height="26" viewBox="0 0 448 512"><path fill="#555" d="M224 202.66A53.34 53.34 0 1 0 277.34 256 53.38 53.38 0 0 0 224 202.66zm124.71-41a54 54 0 0 0-30.37-30.37C286.82 118.09 256 112 224 112s-62.82 6.09-94.34 19.29a54 54 0 0 0-30.37 30.37C118.09 161.18 112 192 112 224s6.09 62.82 19.29 94.34a54 54 0 0 0 30.37 30.37C161.18 393.91 192 400 224 400s62.82-6.09 94.34-19.29a54 54 0 0 0 30.37-30.37C393.91 286.82 400 256 400 224s-6.09-62.82-19.29-94.34z"/></svg>
          </a>
          <a href="https://www.facebook.com/profile.php?id=61581771099083" target="_blank" title="Facebook" style="margin:0 7px; display:inline-block;">
            <svg width="26" height="26" viewBox="0 0 320 512"><path fill="#555" d="M279.14 288l14.22-92.66h-88.91V136.89c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S264.43 0 225.36 0c-73.22 0-121.26 44.38-121.26 124.72V195.3H22.89V288h81.21v224h100.2V288z"/></svg>
          </a>
          <a href="mailto:rich@richdatatech.com" title="Email" style="margin:0 7px; display:inline-block;">
            <svg width="26" height="26" viewBox="0 0 512 512"><path fill="#555" d="M502.3 190.8L327.4 338.3c-13.7 11.6-33.1 11.6-46.8 0L9.7 190.8C3.9 186.1 0 178.9 0 170.9V144c0-35.3 28.7-64 64-64h384c35.3 0 64 28.7 64 64v26.9c0 8-3.9 15.2-9.7 20zM0 400V212.2l218.1 184.5c19.5 16.5 48.4 16.5 67.9 0L512 212.2V400c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64z"/></svg>
          </a>
        </div>
        <div style="font-size:0.99rem; margin-top:5px;">
          <span>Email:</span> <a href="mailto:rich@richdatatech.com" style="color:#fff; text-decoration:underline;">rich@richdatatech.com</a>
        </div>
      </div>
    </div>
  </div>
  <div style="text-align:center; margin-top:18px; font-size:0.9rem; color:#b3c2e0; border-top:1px solid #2a4365; padding-top:10px;">
    © <span id="year"></span> RichDataTech. All rights reserved.
  </div>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
</footer>

<!-- AUTH MODAL -->
<div id="auth-modal" class="fixed inset-0 bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-80 relative">
    <button id="close-auth" class="absolute top-2 right-2 text-gray-500 text-xl" style="background:none; border:none;">&times;</button>
    <h2 id="auth-title" class="text-lg font-semibold mb-4 text-center">Login</h2>
    <input id="email-input" type="email" placeholder="Email" />
    <input id="password-input" type="password" placeholder="Password" />
    <button id="action-btn" class="btn btn-blue w-full">Login</button>
    <a href="#" id="forgot-pass" class="text-xs text-blue-600 block text-center mb-2" style="display:block;">Forgot password?</a>
    <p id="toggle-link" class="text-xs text-center text-gray-600">
      Don’t have an account? <a href="#" class="text-blue-600">Register here</a>
    </p>
    <div class="mt-4 border-t pt-3">
      <button id="google-login" class="btn-google">Continue with Google</button>
      <button id="github-login" class="btn-github">Continue with GitHub</button>
    </div>
    <p id="auth-message" class="text-center text-xs mt-3 text-green-600"></p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script type="module">
/* ----------------------------- 
   SECTION: COURSE/LESSON CONFIG
------------------------------ */
const courseId = "snowflake";
const lessonId = 1;
const ext = ".m3u8";
const hlsPlaylist = `${courseId}${lessonId}.m3u8`;
const totalLessons = 7;
const productId = `paid${lessonId}`;
const stripePriceId = "price_1RqaLeJOLIr6wNsmGRK6tXXP";

/* Firebase Config (unchanged) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  sendPasswordResetEmail, GoogleAuthProvider, GithubAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, onSnapshot, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBorPU13tVHj-o-28ADUkrXE944GIWhGOI",
  authDomain: "course2-f1bdb.firebaseapp.com",
  projectId: "course2-f1bdb",
  storageBucket: "course2-f1bdb.appspot.com",
  messagingSenderId: "954972853845",
  appId: "1:954972853845:web:8bb39ddce360654214e6dc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COURSE_COLLECTION = "course2";

// Elements
const openAuthBtn = document.getElementById("open-auth-btn");
const closeAuth = document.getElementById("close-auth");
const authModal = document.getElementById("auth-modal");
const authTitle = document.getElementById("auth-title");
const actionBtn = document.getElementById("action-btn");
const toggleLink = document.querySelector("#toggle-link a");
const authMessage = document.getElementById("auth-message");
const forgotPass = document.getElementById("forgot-pass");
const loggedInSpan = document.getElementById("logged-in-span");
const statusSpan = document.getElementById("status-span");
const emailInput = document.getElementById("email-input");
const passwordInput = document.getElementById("password-input");

let isRegisterMode = false;
let unsubscribeAccess = null;

function showMsg(msg, color="green") {
  authMessage.textContent = msg;
  authMessage.style.color = color;
  setTimeout(()=>authMessage.textContent="",4000);
}
function showStatus(msg) {
  statusSpan.textContent = msg;
  statusSpan.classList.remove("hidden");
  setTimeout(() => {
    statusSpan.classList.add("hidden");
  }, 4000);
}

// Modal open/close
openAuthBtn.addEventListener("click", () => authModal.classList.remove("hidden"));
closeAuth.addEventListener("click", () => { authModal.classList.add("hidden"); authMessage.textContent=""; });
window.addEventListener("click", e => { if (e.target === authModal) authModal.classList.add("hidden"); });

// Toggle login/register
toggleLink.addEventListener("click", e => {
  e.preventDefault();
  isRegisterMode = !isRegisterMode;
  authTitle.textContent = isRegisterMode ? "Register" : "Login";
  actionBtn.textContent = isRegisterMode ? "Register" : "Login";
  toggleLink.innerHTML = isRegisterMode
    ? `Already have an account? <a href="#" class="text-blue-600">Login</a>`
    : `Don’t have an account? <a href="#" class="text-blue-600">Register here</a>`;
});

// ENTER key triggers login/register
[emailInput, passwordInput].forEach(input => {
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      actionBtn.click();
    }
  });
});

// Auth handler
actionBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) return showMsg("Enter email & password", "red");
  try {
    if (isRegisterMode) {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await ensureUserRecord(cred.user);
      showMsg("Registered successfully!");
      showStatus(`Welcome! ${cred.user.email}`);
    } else {
      await signInWithEmailAndPassword(auth, email, password);
      showMsg("Logged in!");
      showStatus(`Welcome back! ${email}`);
    }
    authModal.classList.add("hidden");
  } catch (err) { showMsg(err.message, "red"); }
});

// Forgot password
forgotPass.addEventListener("click", async (e) => {
  e.preventDefault();
  const email = emailInput.value.trim();
  if (!email) return showMsg("Enter your email first", "red");
  try {
    await sendPasswordResetEmail(auth, email);
    showMsg("Password reset email sent!");
  } catch (err) { showMsg(err.message, "red"); }
});

// OAuth (Google + GitHub)
const googleBtn = document.getElementById("google-login");
const githubBtn = document.getElementById("github-login");
const googleProvider = new GoogleAuthProvider();
const githubProvider = new GithubAuthProvider();
googleBtn.addEventListener("click", ()=>handleOAuthLogin(googleProvider));
githubBtn.addEventListener("click", ()=>handleOAuthLogin(githubProvider));
async function handleOAuthLogin(provider) {
  try {
    const result = await signInWithPopup(auth, provider);
    await ensureUserRecord(result.user);
    authModal.classList.add("hidden");
    showStatus(`Welcome back! ${result.user.email}`);
  } catch (err) { showMsg(err.message, "red"); }
}

// Firestore helper
async function ensureUserRecord(user) {
  const userRef = doc(db, COURSE_COLLECTION, user.uid);
  const snap = await getDoc(userRef);
  if (!snap.exists()) {
    const purchases = {};
    for (let i = 1; i <= 10; i++) {
      purchases[`paid${i}`] = false;
    }
    await setDoc(userRef, {
      email: user.email,
      createdAt: new Date(),
      provider: user.providerData[0].providerId,
      purchases: purchases
    });
  }
}

function renderDemoContent() {
  // Demo variables
  const demoCourseId = "demo";
  const demoLessonId = 2;
  const demoTotalLessons = 20;
  const demoExt = ".m3u8";
  const demoVideoSrc = `https://richdatatech.vercel.app/api/secure-video2/playlist?courseId=${demoCourseId}&lessonId=${demoLessonId}&ext=${demoExt}`;

  // Inject HTML for the demo video and course info
  document.getElementById("course-content").innerHTML = `
    <div class="flex flex-col items-center justify-center max-w-5xl w-full mx-auto">
      <h4 class="text-4xl font-bold text-blue-700 text-center mb-4">
        🔓 Free Demo ${demoCourseId.charAt(0).toUpperCase() + demoCourseId.slice(1)} Lesson ${demoLessonId} Preview
      </h4>
      <div class="mx-auto max-w-3xl w-full mb-8">
        <video
          id="demo-video"
          class="video-js block mx-auto rounded shadow-md"
          controls
          preload="auto"
          playsinline
          autoplay
          muted
        ></video>
        <div id="lesson-progress" class="w-full max-w-3xl mx-auto mt-2 mb-6">
          <div class="flex items-center justify-between mb-1 text-sm">
            <span id="progress-label" class="text-gray-800"></span>
            <span>
              <span class="text-gray-800">Progress:</span>
              <span id="progress-percent" class="font-medium text-black-600"></span>
            </span>
          </div>
          <div class="progress-bar-bg">
            <div id="progress-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4">
          <a href="../courses.html" class="btn btn-blue">← Back</a>
          <h2 class="text-xl font-semibold text-gray-800">Lesson ${demoLessonId} Preview</h2>
          <a href="${demoCourseId}${demoLessonId + 1}.html" class="btn btn-blue">Next →</a>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-8 w-full">
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <p class="text-base leading-relaxed text-black">
            This is a <span class="font-semibold text-blue-700">free preview</span> of our ${demoCourseId.charAt(0).toUpperCase() + demoCourseId.slice(1)} course!
            Enjoy the introductory tips and see what you’ll unlock as a member.
          </p>
          <ul class="list-disc pl-5 space-y-2 text-black text-base mt-4">
            <li>How to import data</li>
            <li>Basic steps</li>
            <li>Building your first visual</li>
          </ul>
        </div>
        <div class="bg-white border border-blue-400 rounded-lg p-6 shadow-sm flex flex-col items-center justify-center">
          <h3 class="text-lg font-semibold mb-2 text-blue-700">Unlock Full Lesson</h3>
          <p class="text-base text-gray-700 mb-4 text-center">
            Get full access to all premium lessons and resources by upgrading now!
          </p>
          <button id="buy-now-btn" class="btn-gradient">
            Buy Now to Unlock
          </button>
          <p class="text-xs text-gray-500 mt-3 text-center">One-time payment, instant access.</p>
        </div>
      </div>
    </div>
  `;

  // SPA-safe Video.js initialization
  if (window.videojs && window.videojs.getPlayer) {
    try {
      const existing = window.videojs.getPlayer("demo-video");
      if (existing) existing.dispose();
    } catch (e) {}
  } else if (window.videojs && window.videojs.players && window.videojs.players["demo-video"]) {
    try {
      window.videojs.players["demo-video"].dispose();
    } catch (e) {}
  }

  // Initialize Video.js player
  const demoPlayer = window.videojs("demo-video", {
    fluid: true,
    autoplay: true,
    controls: true,
    preload: "auto",
    muted: true,
  });

  const videoEl = demoPlayer.el().querySelector("video");

  // Use HLS.js for non-Safari browsers, else use native HLS
  if (window.Hls && !window.videojs.browser.IS_SAFARI) {
    const hls = new window.Hls();
    hls.loadSource(demoVideoSrc);
    hls.attachMedia(videoEl);
  } else {
    demoPlayer.src({ src: demoVideoSrc, type: "application/x-mpegURL" });
  }

  // Disable right-click on the video
  videoEl.addEventListener("contextmenu", (e) => e.preventDefault());

  // Buy button logic
  setTimeout(() => {
    const buyBtn = document.getElementById("buy-now-btn");
    if (buyBtn) buyBtn.onclick = handleStripeCheckout;
  }, 0);

  // Progress bar logic for demo
  const percent = Math.round((demoLessonId / demoTotalLessons) * 100);
  const label = `Lesson ${demoLessonId} / ${demoTotalLessons}`;
  document.getElementById("progress-label").textContent = label;
  document.getElementById("progress-percent").textContent = `${percent}%`;
  document.getElementById("progress-bar").style.width = percent + "%";
}

async function showPaidVideoAndContent() {
  const user = auth.currentUser;
  if (!user) return;

  const idToken = await user.getIdToken();

  document.getElementById("course-content").innerHTML = `
    <div class="flex flex-col items-center justify-center max-w-5xl w-full mx-auto">
      <h4 class="text-4xl font-bold text-blue-700 text-center mb-4">
        🎓 Paid ${courseId.charAt(0).toUpperCase() + courseId.slice(1)} Lesson ${lessonId}
      </h4>
      <div class="mx-auto max-w-3xl w-full mb-8">
        <video
          id="secure-video"
          class="video-js block mx-auto rounded shadow-md"
          controls
          preload="auto"
          playsinline
        ></video>
        <div id="lesson-progress" class="w-full max-w-3xl mx-auto mt-2 mb-6">
          <div class="flex items-center justify-between mb-1 text-sm">
            <span id="progress-label" class="text-gray-800"></span>
            <span>
              <span class="text-gray-800">Progress:</span>
              <span id="progress-percent" class="font-medium text-black-600"></span>
            </span>
          </div>
          <div class="progress-bar-bg">
            <div id="progress-bar" class="progress-bar-fill" style="width:0%"></div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4">
          <a href="../courses.html" class="btn btn-blue">← Back</a>
          <h2 class="text-xl font-semibold text-gray-800">Lesson ${lessonId}</h2>
          <a href="powerbi1.html" class="btn btn-blue">Next →</a>
        </div>
      </div>
      <div class="grid grid-cols-2 gap-8 w-full">
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <p class="text-base leading-relaxed text-black">
            This is a <span class="font-semibold text-green-700">members-only</span> lesson in the
            ${courseId.charAt(0).toUpperCase() + courseId.slice(1)} course.
            You have full access to the lesson video and content!
          </p>
        </div>
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <h3 class="text-lg font-semibold mb-4 text-black">📘 Lesson Focus</h3>
          <ul class="list-disc pl-5 space-y-2 text-black text-base">
            <li>Loading Excel and CSV data into Power BI</li>
            <li>Basic Power Query cleanup</li>
            <li>Simple visuals and charts</li>
            <li>Saving your first report</li>
          </ul>
        </div>
      </div>
    </div>
  `;

  const videoSrc = `https://richdatatech.vercel.app/api/secure-video/playlist?courseId=snowflake&lessonId=1&ext=.m3u8&token=${idToken}`;
  const player = videojs('secure-video', {
    fluid: true,
    autoplay: true,
    controls: true,
    preload: 'auto'
  });
  const videoEl = player.el().querySelector('video');
  if (window.Hls && !videojs.browser.IS_SAFARI) {
    const hls = new Hls();
    hls.loadSource(videoSrc);
    hls.attachMedia(videoEl);
  } else {
    player.src({ src: videoSrc, type: 'application/x-mpegURL' });
  }
  videoEl.addEventListener("contextmenu", e => e.preventDefault());

  // Progress bar logic
  const percent = Math.round((lessonId / totalLessons) * 100);
  const label = `Lesson ${lessonId} / ${totalLessons}`;
  document.getElementById("progress-label").textContent = label;
  document.getElementById("progress-percent").textContent = `${percent}%`;
  document.getElementById("progress-bar").style.width = percent + "%";
}

function handleStripeCheckout() {
  const user = auth.currentUser;
  if (!user) return alert("You must log in to purchase.");
  fetch("https://richdatatech.vercel.app/api/checkout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      uid: user.uid,
      items: [{ price: stripePriceId }],
      productId: productId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.url) window.location.href = data.url;
    else alert("Failed to start checkout.");
  })
  .catch(() => {
    alert("Checkout failed.");
  });
}

onAuthStateChanged(auth, async (user) => {
  openAuthBtn.classList.remove("hidden");
  if (user) {
    loggedInSpan.classList.remove("hidden");
    openAuthBtn.textContent = "Logout";
    openAuthBtn.onclick = async () => {
      authModal.classList.add("hidden");
      await signOut(auth);
      showStatus("Logged out!");
      location.reload();
    };
    listenForAccess(user.uid);
  } else {
    loggedInSpan.classList.add("hidden");
    openAuthBtn.textContent = "Login / Register";
    openAuthBtn.onclick = () => {
      authModal.classList.remove("hidden");
    };
    if (unsubscribeAccess) unsubscribeAccess();
    renderDemoContent();
  }
});

function listenForAccess(uid) {
  if (unsubscribeAccess) unsubscribeAccess();
  const ref = doc(db, COURSE_COLLECTION, uid);
  unsubscribeAccess = onSnapshot(ref, (snap) => {
    if (snap.exists() && snap.data().purchases?.[productId]) {
      showPaidVideoAndContent();
    } else {
      renderDemoContent();
    }
  });
}
renderDemoContent();
</script>
</body>
</html>
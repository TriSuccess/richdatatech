<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure Paid Course â€“ RichDataTech</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

<!-- HEADER -->
<header class="bg-white shadow p-5">
  <div class="flex justify-between items-center">
    <a href="index.html">
      <img src="https://www.richdatatech.com/images/richdatatech.png" alt="RichDataTech Logo" class="h-16 w-auto object-contain"/>
    </a>
    <div id="auth-box" class="flex flex-col items-end">
      <button id="open-auth-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Login / Register</button>
      <span id="logged-in-span" class="hidden text-green-700 text-xs mt-1">Logged In</span>
      <span id="status-span" class="hidden text-blue-600 text-xs mt-1"></span>
    </div>
  </div>
</header>

<main class="pt-4 px-4 flex-grow">
  <h1 class="text-xl font-bold mb-4">Paid Course 1</h1>
  <button id="buy-now-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded hidden">Buy Now</button>
  <div id="paid-content" class="hidden mt-4">
    <!-- Video will be injected here -->
  </div>
</main>

<footer class="bg-gray-900 text-white p-6 text-center">
  &copy; <span id="year"></span> RichDataTech. All rights reserved.
</footer>

<!-- Auth Modal (simplified for brevity) -->
<div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-80 relative">
    <button id="close-auth" class="absolute top-2 right-2 text-gray-500 hover:text-black text-xl">&times;</button>
    <h2 id="auth-title" class="text-lg font-semibold mb-4 text-center">Login</h2>
    <input id="email-input" type="email" placeholder="Email" class="border w-full px-3 py-2 mb-2 rounded" />
    <input id="password-input" type="password" placeholder="Password" class="border w-full px-3 py-2 mb-2 rounded" />
    <button id="action-btn" class="bg-blue-500 hover:bg-blue-600 text-white w-full py-2 rounded mb-2">Login</button>
    <p id="auth-message" class="text-center text-xs mt-3 text-green-600"></p>
  </div>
</div>

<script type="module">
// ----- Firebase Setup -----
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, onSnapshot, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBorPU13tVHj-o-28ADUkrXE944GIWhGOI",
  authDomain: "course2-f1bdb.firebaseapp.com",
  projectId: "course2-f1bdb",
  storageBucket: "course2-f1bdb.appspot.com",
  messagingSenderId: "954972853845",
  appId: "1:954972853845:web:8bb39ddce360654214e6dc"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COURSE_COLLECTION = "course2";

// ----- Elements -----
const openAuthBtn = document.getElementById("open-auth-btn");
const closeAuth = document.getElementById("close-auth");
const authModal = document.getElementById("auth-modal");
const authTitle = document.getElementById("auth-title");
const actionBtn = document.getElementById("action-btn");
const loggedInSpan = document.getElementById("logged-in-span");
const statusSpan = document.getElementById("status-span");
const buyBtn = document.getElementById("buy-now-btn");
const paidContent = document.getElementById("paid-content");
const emailInput = document.getElementById("email-input");
const passwordInput = document.getElementById("password-input");

let isRegisterMode = false;
let unsubscribeAccess = null;

// ----- Auth Modal -----
openAuthBtn.addEventListener("click", () => authModal.classList.remove("hidden"));
closeAuth.addEventListener("click", () => { authModal.classList.add("hidden"); });
window.addEventListener("click", e => { if (e.target === authModal) authModal.classList.add("hidden"); });

actionBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) return showMsg("Enter email & password", "red");
  try {
    if (isRegisterMode) {
      await createUserWithEmailAndPassword(auth, email, password);
      showMsg("Registered successfully!");
    } else {
      await signInWithEmailAndPassword(auth, email, password);
      showMsg("Logged in!");
    }
    authModal.classList.add("hidden");
  } catch (err) { showMsg(err.message, "red"); }
});
function showMsg(msg, color="green") {
  document.getElementById("auth-message").textContent = msg;
  document.getElementById("auth-message").style.color = color;
  setTimeout(()=>{document.getElementById("auth-message").textContent=""},4000);
}

// ----- Auth State -----
onAuthStateChanged(auth, async (user) => {
  openAuthBtn.classList.remove("hidden");
  if (user) {
    loggedInSpan.classList.remove("hidden");
    openAuthBtn.textContent = "Logout";
    openAuthBtn.onclick = async () => {
      authModal.classList.add("hidden");
      await signOut(auth);
      location.reload();
    };
    listenForAccess(user.uid);
  } else {
    loggedInSpan.classList.add("hidden");
    openAuthBtn.textContent = "Login / Register";
    openAuthBtn.onclick = () => { authModal.classList.remove("hidden"); };
    if (unsubscribeAccess) unsubscribeAccess();
    paidContent.classList.add("hidden");
    buyBtn.classList.remove("hidden");
  }
});

// ----- Firestore Purchase Access -----
function listenForAccess(uid) {
  if (unsubscribeAccess) unsubscribeAccess();
  const ref = doc(db, COURSE_COLLECTION, uid);
  unsubscribeAccess = onSnapshot(ref, (snap) => {
    if (snap.exists() && snap.data().purchases?.paid1) {
      showPaidVideo();
      buyBtn.classList.add("hidden");
    } else {
      paidContent.classList.add("hidden");
      buyBtn.classList.remove("hidden");
    }
  });
}

// ----- Show Paid Video Function -----
async function showPaidVideo() {
  const user = auth.currentUser;
  if (!user) return;
  const idToken = await user.getIdToken();
  // Get signed URL from backend
  const res = await fetch("https://richdatatech.vercel.app/api/secure-video.js", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + idToken
    },
    body: JSON.stringify({
      uid: user.uid,
      productId: "paid1"
    })
  });
  if (!res.ok) {
    paidContent.innerHTML = `<div class="text-red-600">You do not have access.</div>`;
    paidContent.classList.remove("hidden");
    return;
  }
  const data = await res.json();
  paidContent.innerHTML = `
    <video width="100%" controls autoplay>
      <source src="${data.url}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <p class="mt-2">This is premium content for Course 1.</p>
  `;
  paidContent.classList.remove("hidden");
}

// ----- Stripe Checkout -----
buyBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("You must log in to purchase.");
  try {
    const res = await fetch("https://richdatatech.vercel.app/api/checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        uid: user.uid,
        items: [{ price: "price_1RqaLeJOLIr6wNsmGRK6tXXP" }],
        productId: "paid1"
      })
    });
    const data = await res.json();
    if (data.url) window.location.href = data.url;
    else alert("Failed to start checkout.");
  } catch (err) {
    alert("Checkout failed.");
  }
});

// ----- Dynamic year -----
document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>
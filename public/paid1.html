<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Paid Course â€“ RichDataTech</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DIN:wght@400;700&display=swap');

/* Header & Nav */
nav a { font-family: 'DIN', sans-serif; text-decoration: none; }
nav a:hover { color: #2563eb; }

header { background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 0.15rem 1rem; }
header .header-top { display: flex; justify-content: space-between; align-items: center; position: relative; }

/* Auth box */
#auth-wrapper { display: table; table-layout: fixed; height: auto; }
#message-placeholder { display: table-row; height: 1rem; text-align: right; font-size: 0.7rem; color: #047857; vertical-align: middle; }
#auth-row { display: table-row; }
#auth-box { display: table-cell; vertical-align: middle; text-align: right; padding-left: 0.5rem; }
#logged-in-span { font-size: 0.7rem; font-weight: normal; color: #065f46; opacity: 0; transition: opacity 0.2s; margin-top: 0.1rem; display: block; }
#logged-in-span.visible { opacity: 1; }
.hidden-input { opacity: 0; pointer-events: none; }
#toggle-link { opacity: 1; transition: opacity 0.2s; font-size: 0.7rem; }
#toggle-link.hidden-link { opacity: 0; pointer-events: none; }

#input-row { display: flex; justify-content: flex-end; gap: 0.2rem; margin-bottom: 0.05rem; }
#button-row { display: flex; justify-content: flex-end; gap: 0.1rem; }
#auth-box a { margin-top: 0.15rem; }
#email-input, #password-input { font-size: 13px; padding: 1px 3px; width: 115px; }
#action-btn { font-size: 13px; padding: 2px 8px; line-height: 1.2; }

nav.main-nav { display: flex; gap: 1.25rem; font-size: 0.95rem; position: absolute; left: 50%; top: 5%; transform: translateX(-50%); }

/* Mobile tweaks */
@media (max-width: 639px) {
  nav.main-nav { position: static; flex-direction: row; justify-content: space-around; width: 100%; margin-top: 0.25rem; gap: 2px; font-size: 0.9rem; transform: none; }
  header { padding-bottom: 0.15rem; }
  #auth-box { display: flex; flex-direction: column; align-items: flex-end; gap: 0.05rem; }
  #input-row { flex-direction: column; align-items: flex-end; margin-bottom: 0.05rem; }
  #email-input, #password-input, #action-btn { width: 100%; }
}

/* Paid content styling */
#paid-content { margin-top: 1rem; }
#buy-now-btn { cursor: pointer; }
</style>
</head>
<body class="bg-gray-100">

<header>
  <div class="header-top">
    <div>
      <a href="index.html">
        <img src="https://www.richdatatech.com/images/richdatatech.png" alt="RichDataTech Logo" class="h-14 sm:h-16 w-auto object-contain"/>
      </a>
    </div>

    <div id="auth-wrapper">
      <div id="message-placeholder"></div>
      <div id="auth-row">
        <div id="auth-box">
          <div id="input-row">
            <input id="email-input" type="email" placeholder="Email" class="px-2 py-1 border rounded"/>
            <input id="password-input" type="password" placeholder="Password" class="px-2 py-1 border rounded"/>
          </div>
          <div id="button-row">
            <button id="action-btn" class="bg-blue-500 hover:bg-blue-600 text-white rounded">Login</button>
          </div>
          <a href="#" id="toggle-link" class="text-blue-600 text-xs block mt-0.5">Don't have an account? Register here.</a>
          <span id="logged-in-span">Logged In</span>
        </div>
      </div>
    </div>
  </div>

  <nav class="main-nav">
    <a href="course1.html">Course 1</a>
    <a href="course2.html">Course 2</a>
    <a href="courses.html">All Courses</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<main class="pt-4 px-4">
  <h1 class="text-xl font-bold">Paid Course Lesson 1</h1>

  <div id="paid1-wrapper">
    <button id="buy-now-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">Buy Now</button>
    <div id="paid-content" style="display:none;">
      <video width="100%" controls>
        <source src="lesson1.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <p>This is premium content for Paid Course 1.</p>
    </div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBorPU13tVHj-o-28ADUkrXE944GIWhGOI",
  authDomain: "course2-f1bdb.firebaseapp.com",
  projectId: "course2-f1bdb",
  storageBucket: "course2-f1bdb.appspot.com",
  messagingSenderId: "954972853845",
  appId: "1:954972853845:web:8bb39ddce360654214e6dc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COURSE_COLLECTION = "course2";

// DOM elements
const emailInput = document.getElementById("email-input");
const passwordInput = document.getElementById("password-input");
const actionBtn = document.getElementById("action-btn");
const toggleLink = document.getElementById("toggle-link");
const loggedInSpan = document.getElementById("logged-in-span");
const messagePlaceholder = document.getElementById("message-placeholder");

const buyBtn = document.getElementById("buy-now-btn");
const paidContent = document.getElementById("paid-content");

let isRegisterMode = false;

// Show temporary messages
function showMessage(msg, color="green") {
  messagePlaceholder.textContent = msg;
  messagePlaceholder.style.color = color;
  setTimeout(() => { messagePlaceholder.textContent = ""; }, 4000);
}

// Toggle register/login
toggleLink.addEventListener("click", e => {
  e.preventDefault();
  if (auth.currentUser) return;
  isRegisterMode = !isRegisterMode;
  actionBtn.textContent = isRegisterMode ? "Register" : "Login";
  toggleLink.textContent = isRegisterMode ? "Already have an account?" : "Don't have an account?";
});

// Auth handler
async function handleAuth() {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) { showMessage("Enter email & password", "red"); return; }

  if (isRegisterMode) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      showMessage("Welcome!");
      passwordInput.value = "";
    } catch (err) { showMessage("Registration failed: "+err.message, "red"); }
  } else {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      showMessage("Logged in");
      passwordInput.value = "";
    } catch (err) { showMessage("Login failed: "+err.message, "red"); }
  }
}

actionBtn.addEventListener("click", handleAuth);
[emailInput, passwordInput].forEach(input => input.addEventListener("keyup", e => { if(e.key==="Enter") handleAuth(); }));

// Check paid access
async function checkAccess(uid) {
  const docRef = doc(db, COURSE_COLLECTION, uid);
  const snap = await getDoc(docRef);
  if (snap.exists()) {
    const data = snap.data();
    if (data.purchases?.paid1) {
      paidContent.style.display = "block";
      buyBtn.style.display = "none";
    } else {
      paidContent.style.display = "none";
      buyBtn.style.display = "block";
    }
  }
}

// Auth state listener
onAuthStateChanged(auth, user => {
  if (user) {
    loggedInSpan.classList.add("visible");
    emailInput.classList.add("hidden-input");
    passwordInput.classList.add("hidden-input");
    toggleLink.classList.add("hidden-link");
    actionBtn.textContent = "Logout";
    actionBtn.onclick = async () => { await signOut(auth); location.reload(); };
    checkAccess(user.uid);
  } else {
    loggedInSpan.classList.remove("visible");
    emailInput.classList.remove("hidden-input");
    passwordInput.classList.remove("hidden-input");
    toggleLink.classList.remove("hidden-link");
    actionBtn.textContent = isRegisterMode ? "Register" : "Login";
    actionBtn.onclick = handleAuth;
    paidContent.style.display = "none";
    buyBtn.style.display = "block";
  }
});

// Stripe checkout
buyBtn.addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return alert("You must log in to purchase.");

  try {
    const res = await fetch("https://richdatatech.vercel.app/api/checkout", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        uid: user.uid,
        items: [
          { name: "Paid Course 1", price: 1000, quantity: 1 }
        ]
      }),
    });

    const data = await res.json();
    if (data.url) window.location.href = data.url;
    else alert("Failed to start checkout. Check console.");
  } catch (err) {
    console.error("Checkout error:", err);
    alert("Checkout failed.");
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paid Course ‚Äì RichDataTech</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body, * { font-family: 'Proxima Nova', sans-serif; }
    /* ...header and footer styles as before... */
  </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

<!-- HEADER -->
<header>
  <div class="header-top">
    <div>
      <a href="index.html">
        <img src="https://www.richdatatech.com/images/richdatatech.png" alt="RichDataTech Logo" class="h-16 sm:h-20 w-auto object-contain"/>
      </a>
    </div>
    <div id="auth-box" class="flex flex-col items-end">
      <button id="open-auth-btn" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">Login / Register</button>
      <span id="logged-in-span" class="hidden text-green-700 text-xs mt-1">Logged In</span>
      <span id="status-span" class="hidden text-blue-600 text-xs mt-1"></span>
    </div>
  </div>
  <nav class="main-nav">
    <a href="powerbi.html">Power BI</a>
    <a href="courses.html">All Courses</a>
    <a href="aipowertips.html">AI Power Tips</a>
    <a href="about.html">About</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<!-- MAIN -->
<main class="pt-4 px-4 flex-grow bg-gradient-to-r from-gray-300 via-gray-300 to-gray-200">
  <div id="course-content" class="mt-8"></div>
  <br><br>
</main>

<!-- FOOTER (keep as before) -->
<footer style="background:#23272a; color:#fff; padding:38px 0 18px 0;">
  <!-- ...footer content as before... -->
  <div style="text-align:center; margin-top:18px; font-size:0.9rem; color:#b3c2e0; border-top:1px solid #2a4365; padding-top:10px;">
    ¬© <span id="year"></span> RichDataTech. All rights reserved.
  </div>
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();
  </script>
</footer>

<!-- AUTH MODAL (same as before) -->
<div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <!-- ...modal content as before... -->
</div>

<!-- HLS.js for adaptive video streaming -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<script type="module">
/* ----------------------------- 
   SECTION: COURSE/LESSON CONFIG
   Change these values to select video!
------------------------------ */
const courseId = "snowflake";
const lessonId = 2; // e.g. 2 for snowflake2, 3 for databricks3, etc.
const totalLessons = 7;
const hlsPlaylist = `pbic7i/${courseId}${lessonId}.m3u8`;
// For checkout
const productId = `paid${lessonId}`;
const stripePriceId = "price_1RqaLeJOLIr6wNsmGRK6tXXP"; // change if needed per lesson

// Firebase Config (unchanged)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut,
  createUserWithEmailAndPassword, signInWithEmailAndPassword,
  sendPasswordResetEmail, GoogleAuthProvider, GithubAuthProvider,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, onSnapshot, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBorPU13tVHj-o-28ADUkrXE944GIWhGOI",
  authDomain: "course2-f1bdb.firebaseapp.com",
  projectId: "course2-f1bdb",
  storageBucket: "course2-f1bdb.appspot.com",
  messagingSenderId: "954972853845",
  appId: "1:954972853845:web:8bb39ddce360654214e6dc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COURSE_COLLECTION = "course2";

// Elements
const openAuthBtn = document.getElementById("open-auth-btn");
const closeAuth = document.getElementById("close-auth");
const authModal = document.getElementById("auth-modal");
const authTitle = document.getElementById("auth-title");
const actionBtn = document.getElementById("action-btn");
const toggleLink = document.querySelector("#toggle-link a");
const authMessage = document.getElementById("auth-message");
const forgotPass = document.getElementById("forgot-pass");
const loggedInSpan = document.getElementById("logged-in-span");
const statusSpan = document.getElementById("status-span");
const emailInput = document.getElementById("email-input");
const passwordInput = document.getElementById("password-input");

let isRegisterMode = false;
let unsubscribeAccess = null;

function showMsg(msg, color="green") {
  authMessage.textContent = msg;
  authMessage.style.color = color;
  setTimeout(()=>authMessage.textContent="",4000);
}

function showStatus(msg) {
  statusSpan.textContent = msg;
  statusSpan.classList.remove("hidden");
  setTimeout(() => {
    statusSpan.classList.add("hidden");
  }, 4000);
}

// Modal open/close
openAuthBtn.addEventListener("click", () => authModal.classList.remove("hidden"));
closeAuth.addEventListener("click", () => { authModal.classList.add("hidden"); authMessage.textContent=""; });
window.addEventListener("click", e => { if (e.target === authModal) authModal.classList.add("hidden"); });

// Toggle login/register
toggleLink.addEventListener("click", e => {
  e.preventDefault();
  isRegisterMode = !isRegisterMode;
  authTitle.textContent = isRegisterMode ? "Register" : "Login";
  actionBtn.textContent = isRegisterMode ? "Register" : "Login";
  toggleLink.innerHTML = isRegisterMode
    ? `Already have an account? <a href="#" class="text-blue-600 hover:underline">Login</a>`
    : `Don‚Äôt have an account? <a href="#" class="text-blue-600 hover:underline">Register here</a>`;
});

// ENTER key triggers login/register
[emailInput, passwordInput].forEach(input => {
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      actionBtn.click();
    }
  });
});

// Auth handler
actionBtn.addEventListener("click", async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  if (!email || !password) return showMsg("Enter email & password", "red");
  try {
    if (isRegisterMode) {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await ensureUserRecord(cred.user);
      showMsg("Registered successfully!");
      showStatus(`Welcome! ${cred.user.email}`);
    } else {
      await signInWithEmailAndPassword(auth, email, password);
      showMsg("Logged in!");
      showStatus(`Welcome back! ${email}`);
    }
    authModal.classList.add("hidden");
  } catch (err) { showMsg(err.message, "red"); }
});

// Forgot password
forgotPass.addEventListener("click", async (e) => {
  e.preventDefault();
  const email = emailInput.value.trim();
  if (!email) return showMsg("Enter your email first", "red");
  try {
    await sendPasswordResetEmail(auth, email);
    showMsg("Password reset email sent!");
  } catch (err) { showMsg(err.message, "red"); }
});

// OAuth (Google + GitHub)
const googleBtn = document.getElementById("google-login");
const githubBtn = document.getElementById("github-login");
const googleProvider = new GoogleAuthProvider();
const githubProvider = new GithubAuthProvider();
googleBtn.addEventListener("click", ()=>handleOAuthLogin(googleProvider));
githubBtn.addEventListener("click", ()=>handleOAuthLogin(githubProvider));
async function handleOAuthLogin(provider) {
  try {
    const result = await signInWithPopup(auth, provider);
    await ensureUserRecord(result.user);
    authModal.classList.add("hidden");
    showStatus(`Welcome back! ${result.user.email}`);
  } catch (err) { showMsg(err.message, "red"); }
}

// Firestore helper
async function ensureUserRecord(user) {
  const userRef = doc(db, COURSE_COLLECTION, user.uid);
  const snap = await getDoc(userRef);
  if (!snap.exists()) {
    const purchases = {};
    for (let i = 1; i <= 10; i++) {
      purchases[`paid${i}`] = false;
    }
    await setDoc(userRef, {
      email: user.email,
      createdAt: new Date(),
      provider: user.providerData[0].providerId,
      purchases: purchases
    });
  }
}

// Main dynamic content rendering
function renderFreeContent() {
  document.getElementById("course-content").innerHTML = `
    <div class="flex flex-col items-center justify-center max-w-5xl w-full space-y-2 mx-auto">
      <h4 class="text-4xl font-bold text-blue-700 text-center mb-4">üîì Free Power BI Lesson 1 Preview</h4>
      <div class="mx-auto max-w-3xl w-full mb-8">
        <video id="free-video" class="w-full rounded shadow-md block mx-auto" controls playsinline>
          <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
          Your browser does not support the video tag.
        </video>
        <div class="flex items-center justify-between mt-4">
          <a href="../courses.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow">‚Üê Back</a>
          <h2 class="text-xl font-semibold text-gray-800">Lesson 1 Preview</h2>
          <a href="powerbi1.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow">Next ‚Üí</a>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-8 w-full">
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <p class="text-base leading-relaxed text-black">
            This is a <span class="font-semibold text-blue-700">free preview</span> of our Power BI beginner course!
            Enjoy the introductory tips and see what you‚Äôll unlock as a member.
          </p>
          <ul class="list-disc pl-5 space-y-2 text-black text-base mt-4">
            <li>How to import data into Power BI</li>
            <li>Basic Power Query steps</li>
            <li>Building your first visual</li>
          </ul>
        </div>
        <div class="bg-white border border-blue-400 rounded-lg p-6 shadow-sm flex flex-col items-center justify-center">
          <h3 class="text-lg font-semibold mb-2 text-blue-700">Unlock Full Lesson</h3>
          <p class="text-base text-gray-700 mb-4 text-center">
            Get full access to all premium lessons and resources by upgrading now!
          </p>
          <button id="buy-now-btn" class="bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white px-6 py-2 rounded-md text-base font-semibold shadow transition-all duration-150">
            Buy Now to Unlock
          </button>
          <p class="text-xs text-gray-500 mt-3 text-center">One-time payment, instant access.</p>
        </div>
      </div>
    </div>
  `;
  // Attach event after rendering
  setTimeout(() => {
    const buyBtn = document.getElementById("buy-now-btn");
    if (buyBtn) buyBtn.onclick = handleStripeCheckout;
  }, 0);
}

async function showPaidVideoAndContent() {
  const user = auth.currentUser;
  if (!user) return;

  const idToken = await user.getIdToken();
  const videoSrc = `https://richdatatech.vercel.app/api/secure-video?file=${encodeURIComponent(hlsPlaylist)}&token=${idToken}`;

  document.getElementById("course-content").innerHTML = `
    <div class="flex flex-col items-center justify-center max-w-5xl w-full space-y-2 mx-auto">
      <h4 class="text-4xl font-bold text-blue-700 text-center mb-4">
        üéì Paid ${courseId.charAt(0).toUpperCase() + courseId.slice(1)} Lesson ${lessonId}
      </h4>
      <div class="mx-auto max-w-3xl w-full mb-8">
        <video id="secure-video" class="w-full rounded shadow-md block mx-auto" controls autoplay playsinline></video>
        <!-- Progress Bar -->
        <div id="lesson-progress" class="w-full max-w-3xl mx-auto mt-2 mb-6">
          <div class="flex items-center justify-between mb-1 text-sm">
            <span id="progress-label" class="text-gray-800"></span>
            <span>
              <span class="text-gray-800">Progress:</span>
              <span id="progress-percent" class="font-medium text-black-600"></span>
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progress-bar" class="bg-blue-600 h-3 rounded-full" style="width:0%"></div>
          </div>
        </div>
        <div class="flex items-center justify-between mt-4">
          <a href="../courses.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow">‚Üê Back</a>
          <h2 class="text-xl font-semibold text-gray-800">Lesson ${lessonId}</h2>
          <a href="powerbi1.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow">Next ‚Üí</a>
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-8 w-full">
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <p class="text-base leading-relaxed text-black">
            This is a <span class="font-semibold text-green-700">members-only</span> lesson in the ${courseId.charAt(0).toUpperCase() + courseId.slice(1)} course.
            You have full access to the lesson video and content!
          </p>
        </div>
        <div class="bg-white border border-gray-500 rounded-lg p-6 shadow-sm">
          <h3 class="text-lg font-semibold mb-4 text-black">üìò Lesson Focus</h3>
          <ul class="list-disc pl-5 space-y-2 text-black text-base">
            <li>Loading Excel and CSV data into Power BI</li>
            <li>Basic Power Query cleanup</li>
            <li>Simple visuals and charts</li>
            <li>Saving your first report</li>
          </ul>
        </div>
      </div>
    </div>
  `;

  // HLS.js player setup for universal browser support
  const video = document.getElementById("secure-video");
  if (!video) return;
  if (window.Hls && window.Hls.isSupported()) {
    const hls = new window.Hls();
    hls.loadSource(videoSrc);
    hls.attachMedia(video);
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = videoSrc;
  } else {
    video.outerHTML = '<div class="text-red-600 font-bold">Your browser does not support secure video streaming. Please use a modern browser.</div>';
  }

  // Disable right-click
  video.addEventListener("contextmenu", e => e.preventDefault());

  // Progress Bar Logic
  const percent = Math.round((lessonId / totalLessons) * 100);
  const label = `Lesson ${lessonId} / ${totalLessons}`;
  if (document.getElementById("progress-label")) {
    document.getElementById("progress-label").textContent = label;
    document.getElementById("progress-percent").textContent = `${percent}%`;
    document.getElementById("progress-bar").style.width = percent + "%";
  }
}

// Stripe checkout logic
function handleStripeCheckout() {
  const user = auth.currentUser;
  if (!user) return alert("You must log in to purchase.");
  fetch("https://richdatatech.vercel.app/api/checkout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      uid: user.uid,
      items: [{ price: stripePriceId }],
      productId: productId
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.url) window.location.href = data.url;
    else alert("Failed to start checkout.");
  })
  .catch(() => {
    alert("Checkout failed.");
  });
}

// Auth state and Firestore access logic
onAuthStateChanged(auth, async (user) => {
  openAuthBtn.classList.remove("hidden");
  if (user) {
    loggedInSpan.classList.remove("hidden");
    openAuthBtn.textContent = "Logout";
    openAuthBtn.onclick = async () => {
      authModal.classList.add("hidden");
      await signOut(auth);
      showStatus("Logged out!");
      location.reload();
    };
    listenForAccess(user.uid);
  } else {
    loggedInSpan.classList.add("hidden");
    openAuthBtn.textContent = "Login / Register";
    openAuthBtn.onclick = () => {
      authModal.classList.remove("hidden");
    };
    if (unsubscribeAccess) unsubscribeAccess();
    renderFreeContent();
  }
});

function listenForAccess(uid) {
  if (unsubscribeAccess) unsubscribeAccess();
  const ref = doc(db, COURSE_COLLECTION, uid);
  unsubscribeAccess = onSnapshot(ref, (snap) => {
    if (snap.exists() && snap.data().purchases?.[productId]) {
      showPaidVideoAndContent();
    } else {
      renderFreeContent();
    }
  });
}

// Render free content on first load (even before auth)
renderFreeContent();

</script>
</body>
</html>